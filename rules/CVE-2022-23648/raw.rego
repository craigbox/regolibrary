package armo_builtins

deny[msga] {
	node := input[_]
    node.kind == "Node"
    
    startswith(node.status.nodeInfo.containerRuntimeVersion,"containerd://")
    containerd_version := substring(node.status.nodeInfo.containerRuntimeVersion,13,-1)
    containerd_version_arr := split(containerd_version, ".")
    major_version := to_number(containerd_version_arr[0]) 
    minor_version := to_number(containerd_version_arr[1]) 
    subVersion := to_number(containerd_version_arr[2]) 
    
    is_vulnerable_version(major_version,minor_version,subVersion)

    path := "status.nodeInfo.containerRuntimeVersion"

 	msga := {
			"alertMessage": "You are vulnerable to CVE-2022-23648",
    		"alertObject": {
               "k8SApiObjects": [node]
            },
			"reviewPaths": [path],
			"failedPaths": [path],
            "fixPaths":[],
	}
}


is_vulnerable_version(major_version, minor_version, subVersion) {
	major_version == 0
} 

is_vulnerable_version(major_version, minor_version, subVersion) {
	major_version == 1
	minor_version < 4
}

is_vulnerable_version(major_version, minor_version, subVersion) {
	major_version == 1
	minor_version == 4
	subVersion < 12
}

is_vulnerable_version(major_version, minor_version, subVersion) {
	major_version == 1
	minor_version == 5
	subVersion < 10
}	

is_vulnerable_version(major_version, minor_version, subVersion) {
	major_version == 1
	minor_version == 6
	subVersion < 1
}	

