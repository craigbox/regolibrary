package armo_builtins

deny[msga] {
	deployment := input[_]
	deployment.kind == "Deployment"
	image := deployment.spec.template.spec.containers[i].image
	contains(image, "argocd:v")
	is_vulnerable_image(image)
	path := sprintf("spec.template.spec.containers[%v].image", [format_int(i, 10)])
    msga := {
			"alertMessage": "You may be vulnerable to CVE-2022-24348",
			"reviewPaths": [path],
			"failedPaths": [path],
			"fixPaths":[],
			"alertObject": { 
                "k8SApiObjects": [deployment]
            },
		}
}

is_vulnerable_image(image) {
	version := split(image, ":v")[1]
	versionTriplet := split(version, ".")
	count(versionTriplet) == 3
	major_version := to_number(versionTriplet[0])
	minorVersion := to_number(versionTriplet[1])
	subVersion := to_number(versionTriplet[2])  
	isVulnerableVersion(major_version,minorVersion,subVersion)
}

isVulnerableVersion(major_version, minorVersion, subVersion) {
	major_version == 1
} 

isVulnerableVersion(major_version, minorVersion, subVersion) {
	major_version == 2
	minorVersion == 0
}

isVulnerableVersion(major_version, minorVersion, subVersion) {
	major_version == 2
	minorVersion == 1
	subVersion < 9
}

isVulnerableVersion(major_version, minorVersion, subVersion) {
	major_version == 2
	minorVersion == 2
	subVersion < 4
}	

